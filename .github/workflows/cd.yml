name: CD (Continuous Deployment)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup PNPM
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 9

      - name: Setup Node & PNPM cache
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Prepare Firebase service account for build (temp file)
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > service-account-file.json
      - name: Build app (Next.js standalone)
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON_PATH: ${{ github.workspace }}/service-account-file.json
          NEXT_TELEMETRY_DISABLED: "1"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: pnpm build
      - name: Cleanup temp secrets
        if: always()
        run: rm -f service-account-file.json

      - name: Prepare minimal docker context
        run: |
          mkdir -p docker_ctx/.next
          cp -r .next/standalone docker_ctx/.next/standalone
          cp -r .next/static docker_ctx/.next/static
          if [ -d public ]; then cp -r public docker_ctx/public; fi
          cp Dockerfile docker_ctx/Dockerfile

      - name: Login to Docker Hub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

      - name: Build & push image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          IMAGE="${DOCKERHUB_USERNAME}/git-repo-analysis"
          GIT_SHA="${{ github.sha }}"
          docker build -t ${IMAGE}:latest -t ${IMAGE}:${GIT_SHA} docker_ctx
          docker push ${IMAGE}:latest
          docker push ${IMAGE}:${GIT_SHA}
      - name: Generate .env from secrets
        run: |
          mkdir -p env_out
          {
            echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}"
            echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}"
            echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}"
            echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}"
            echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}"
            echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}"
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}"
            echo "FIREBASE_SERVICE_ACCOUNT_JSON_PATH=./service-account-file.json"
            echo "PORT=3000"
          } > env_out/.env

      - name: Write Firebase service account file
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > env_out/service-account-file.json

      - name: Upload env and service account to VM
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "env_out/.env,env_out/service-account-file.json"
          target: "${{ secrets.VM_APP_DIR || '/opt/git-repo-analysis' }}/shared"
          overwrite: true

      - name: Deploy on VM (install docker if needed, pull & run)
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            APP_DIR="${{ secrets.VM_APP_DIR || '/opt/git-repo-analysis' }}"
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/git-repo-analysis:latest"
            CONTAINER="git-repo-analysis"
            EXTERNAL_PORT="${{ secrets.DEPLOY_PORT || '3000' }}"

            sudo mkdir -p "$APP_DIR/shared"
            sudo chown -R $USER:$USER "$APP_DIR"

            if ! command -v docker >/dev/null 2>&1; then
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker $USER || true
            fi

            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            docker pull "$IMAGE"

            if [ "$(docker ps -q -f name=${CONTAINER})" ]; then
              docker stop ${CONTAINER} || true
              docker rm ${CONTAINER} || true
            elif [ "$(docker ps -aq -f name=${CONTAINER})" ]; then
              docker rm ${CONTAINER} || true
            fi

            docker run -d \
              --name ${CONTAINER} \
              --restart unless-stopped \
              --env-file "$APP_DIR/shared/.env" \
              -v "$APP_DIR/shared/service-account-file.json:/app/service-account-file.json:ro" \
              -p ${EXTERNAL_PORT}:3000 \
              "$IMAGE"

            docker image prune -f || true
