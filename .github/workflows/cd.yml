name: CD (Continuous Deployment)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy-to-vm:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            APP_DIR="${{ secrets.VM_APP_DIR || '$HOME/git-repo-analysis' }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            PORT="${{ secrets.DEPLOY_PORT || '3000' }}"

            cd "$APP_DIR"

            echo "Stopping existing application..."
            if [ -f ".next.pid" ]; then
              OLD_PID=$(cat .next.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                kill $OLD_PID || true
                sleep 2
                if ps -p $OLD_PID > /dev/null 2>&1; then
                  kill -9 $OLD_PID || true
                fi
              fi
              rm -f .next.pid
            fi

            EXISTING_PROCESS=$(lsof -ti:$PORT || true)
            if [ -n "$EXISTING_PROCESS" ]; then
              echo "Killing process on port $PORT: $EXISTING_PROCESS"
              kill -9 $EXISTING_PROCESS || true
              sleep 1
            fi

            echo "Pulling latest code..."
            git pull origin main

            echo "Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "Building application..."
            export FIREBASE_SERVICE_ACCOUNT_JSON_PATH="$APP_DIR/service-account-file.json"
            export NEXT_TELEMETRY_DISABLED=1
            pnpm build

            echo "Starting application on port $PORT..."
            export PORT=$PORT
            nohup pnpm start > app.log 2>&1 &
            echo $! > .next.pid

            sleep 5

            if ps -p $(cat .next.pid) > /dev/null 2>&1; then
              echo "Application started successfully! PID: $(cat .next.pid)"
              echo "Log file: $APP_DIR/app.log"
              echo "Application should be available on port $PORT"
            else
              echo "Failed to start application"
              echo "Last 20 lines of log:"
              tail -20 app.log
              exit 1
            fi

            echo "Deployment completed!"
