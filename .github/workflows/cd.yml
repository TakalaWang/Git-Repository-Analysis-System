name: CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy-to-vm:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy & Build on VM (latest Node + pnpm; fix libatomic & approve builds)
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail

            # ===== Parameters =====
            APP_DIR="${{ secrets.VM_APP_DIR }}"; APP_DIR="${APP_DIR:-$HOME/git-repo-analysis}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            PORT="${{ secrets.DEPLOY_PORT }}"; PORT="${PORT:-3000}"
            SERVICE_NAME="${SERVICE_NAME:-git-repo-analysis}"

            echo "APP_DIR=$APP_DIR  PORT=$PORT"

            # ===== Install latest Node via nvm, enable latest pnpm via corepack =====
            export NVM_DIR="$HOME/.nvm"
            if [ ! -s "$NVM_DIR/nvm.sh" ]; then
              echo "Installing nvm..."
              mkdir -p "$NVM_DIR"
              curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
            fi
            # shellcheck disable=SC1090
            . "$NVM_DIR/nvm.sh"

            echo "Installing latest Node (channel: node)..."
            nvm install --no-progress node
            nvm alias default node
            nvm use default

            if command -v corepack >/dev/null 2>&1; then
              corepack enable || true
              corepack prepare pnpm@latest --activate || true
            fi

            export PNPM_HOME="${PNPM_HOME:-$HOME/.local/share/pnpm}"
            export PATH="$PNPM_HOME:$PATH"

            if ! command -v pnpm >/dev/null 2>&1; then
              echo "pnpm not found; installing..."
              curl -fsSL https://get.pnpm.io/install.sh | sh -
              export PATH="$PNPM_HOME:$PATH"
            fi

            need_atomic_fix=false
            set +e
            node -e "console.log('node-ok')" >/dev/null 2>&1 || need_atomic_fix=true
            set -e
            if $need_atomic_fix; then
              echo "Node needs libatomic.so.1; installing the libatomic package..."
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y libatomic1
              elif command -v yum >/dev/null 2>&1 || command -v dnf >/dev/null 2>&1; then
                sudo yum install -y libatomic || sudo dnf install -y libatomic
              elif command -v apk >/dev/null 2>&1; then
                sudo apk add --no-cache libatomic
              else
                echo "Cannot detect package manager to install libatomic.*"; exit 1
              fi
            fi

            echo "Node: $(node -v 2>/dev/null || echo 'missing')"
            echo "pnpm: $(pnpm -v 2>/dev/null || echo 'missing')"

            # ===== Fetch latest code =====
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            if [ -d .git ]; then
              git remote set-url origin "$REPO_URL" || true
              git fetch --all --prune
              git reset --hard origin/main
            else
              git clone "$REPO_URL" .
              git checkout main || true
            fi

            # ===== Stop existing app =====
            stop_port () {
              local port="$1"
              local pids
              pids="$(ss -lptn "sport = :$port" 2>/dev/null | sed -n 's/.*pid=\([0-9][0-9]*\).*/\1/p' | sort -u || true)"
              if [ -n "$pids" ]; then
                echo "Killing processes on port $port: $pids"
                for p in $pids; do kill "$p" 2>/dev/null || true; done
                sleep 1
                for p in $pids; do kill -9 "$p" 2>/dev/null || true; done
              else
                echo "No process found on port $port"
              fi
            }

            if command -v systemctl >/dev/null 2>&1 && systemctl list-units --type=service | grep -q "$SERVICE_NAME"; then
              echo "Stopping systemd service: $SERVICE_NAME"
              sudo systemctl stop "$SERVICE_NAME" || true
            else
              echo "Stopping via pidfile/port..."
              if [ -f ".next.pid" ]; then
                OLD_PID="$(cat .next.pid || true)"
                if [ -n "${OLD_PID:-}" ] && kill -0 "$OLD_PID" 2>/dev/null; then
                  kill "$OLD_PID" || true
                  sleep 1
                  kill -9 "$OLD_PID" 2>/dev/null || true
                fi
                rm -f .next.pid
              fi
              stop_port "$PORT"
            fi

            # ===== Install deps (approve build scripts), then build =====
            echo "Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "Building app..."
            export NEXT_TELEMETRY_DISABLED=1
            pnpm build

            # ===== Start app =====
            if command -v systemctl >/dev/null 2>&1 && systemctl list-units --type=service | grep -q "$SERVICE_NAME"; then
              echo "Starting via systemd: $SERVICE_NAME"
              sudo systemctl start "$SERVICE_NAME"
              sudo systemctl status "$SERVICE_NAME" --no-pager -l || true
            else
              echo "Starting via nohup on port $PORT..."
              export PORT="$PORT"
              nohup pnpm start > app.log 2>&1 &
              echo $! > .next.pid
              sleep 5
              if ps -p "$(cat .next.pid)" >/dev/null 2>&1; then
                echo "Started. PID=$(cat .next.pid)"
                echo "Logs: $APP_DIR/app.log"
              else
                echo "Start failed. Last 80 lines:"
                tail -80 app.log || true
                exit 1
              fi
            fi

            echo "Deployment completed."
