name: CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy-to-vm:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail

            APP_DIR="${{ secrets.VM_APP_DIR }}"; APP_DIR="${APP_DIR:-$HOME/git-repo-analysis}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            PORT="${{ secrets.DEPLOY_PORT }}"; PORT="${PORT:-3000}"

            echo "APP_DIR=$APP_DIR  PORT=$PORT"

            # ===== Repo =====
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            if [ ! -d .git ]; then
              git clone "$REPO_URL" .
            else
              git fetch origin
            fi
            git checkout -f main
            git reset --hard origin/main

            # ===== Stop old app (use ss; no lsof needed) =====
            echo "Stopping existing app (if any)..."
            if [ -f ".next.pid" ]; then
              OLD_PID="$(cat .next.pid || true)"
              if [ -n "$OLD_PID" ] && ps -p "$OLD_PID" > /dev/null 2>&1; then
                kill "$OLD_PID" || true
                sleep 2
                ps -p "$OLD_PID" > /dev/null 2>&1 && kill -9 "$OLD_PID" || true
              fi
              rm -f .next.pid
            fi

            PID="$(ss -tulpn 2>/dev/null | grep ":$PORT " | awk '{split($NF,a,\","); print a[2]}' | head -n1 || true)"
            if [ -n "$PID" ]; then
              echo "Killing process on port $PORT (PID: $PID)"
              kill -9 "$PID" || true
              sleep 1
            else
              echo "No process found on port $PORT"
            fi

            # ===== Build & start (pnpm is already installed on VM) =====
            echo "Installing deps..."
            pnpm install --frozen-lockfile

            echo "Building..."
            export NEXT_TELEMETRY_DISABLED=1
            export FIREBASE_SERVICE_ACCOUNT_JSON_PATH="$APP_DIR/service-account-file.json"
            pnpm build

            echo "Starting app on port $PORT..."
            export PORT="$PORT"
            nohup pnpm start > app.log 2>&1 &
            echo $! > .next.pid

            sleep 5
            if ps -p "$(cat .next.pid)" > /dev/null 2>&1; then
              echo "Started. PID=$(cat .next.pid)"
              echo "Logs: $APP_DIR/app.log"
            else
              echo "Start failed. Last 50 lines:"
              tail -50 app.log || true
              exit 1
            fi

            echo "Deployment completed!"
